<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WSUS SQL SOP - Accelerating WSUS Deployment with SQL Server Express 2022</title>
</head>
<body>
  <h1>WSUS SQL SOP - Accelerating WSUS Deployment with SQL Server Express 2022</h1>

  <h2>Purpose</h2>
  <p>
    This SOP describes how to deploy and sustain a WSUS server backed by SQL Server Express 2022
    using the automation scripts in this repository. It focuses on the end-to-end flow and references
    the scripts to use at each stage, without embedding script content.
  </p>

  <h2>Scope</h2>
  <ul>
    <li>Build and configure a WSUS server with SQL Express 2022.</li>
    <li>Validate WSUS content path and permissions.</li>
    <li>Maintain upstream (online) and downstream (airgapped/offline) WSUS servers.</li>
    <li>Apply GPO settings for WSUS client configuration.</li>
  </ul>

  <h2>Prerequisites</h2>
  <ul>
    <li>Copy this repository to the target WSUS server.</li>
    <li>Place SQL Express 2022 and SSMS installers in <strong>C:\WSUS\SQLDB</strong>.</li>
    <li>Ensure the WSUS content store is <strong>C:\WSUS</strong>.</li>
    <li>For GPO work, run on a Domain Controller with RSAT Group Policy Management installed.</li>
  </ul>

  <h2>Recommended folder layout</h2>
  <ul>
    <li><strong>C:\WSUS\SQLDB</strong>: SQL + SSMS installers and logs.</li>
    <li><strong>C:\WSUS</strong>: WSUS content store (required location).</li>
    <li><strong>C:\WSUS\Scripts</strong>: WSUS automation scripts from this repo.</li>
    <li><strong>C:\WSUS\Logs</strong>: Log output location.</li>
  </ul>

  <h2>Quick start flow (recommended)</h2>
  <ol>
    <li>
      <strong>Install WSUS + SQL Express 2022</strong> using
      <em>Run-WsusSql.ps1</em> (the recommended entry point).
    </li>
    <li>
      <strong>Validate content path and permissions</strong> using
      <em>Check-WSUSContent.ps1</em> with issue remediation enabled if needed.
    </li>
    <li>
      <strong>Online WSUS only</strong>: configure products/classifications in the WSUS console and
      run the initial synchronization before exporting.
    </li>
    <li>
      <strong>Airgapped/offline WSUS</strong>: restore the latest SUSDB backup and import content
      from the online server export location.
    </li>
  </ol>

  <h2>Online vs. airgapped/offline workflow</h2>
  <h3>Online (upstream) WSUS server</h3>
  <ul>
    <li>Build using <em>Run-WsusSql.ps1</em> (install flow).</li>
    <li>Keep WSUS healthy and generate exports with <em>WsusMaintenance.ps1</em>.</li>
    <li>Run <em>Ultimate-WsusCleanup.ps1</em> on a quarterly or as-needed basis.</li>
    <li>Export location for downstream transfers: <strong>D:\WSUS-Exports</strong>.</li>
  </ul>

  <h3>Airgapped/offline WSUS server</h3>
  <ul>
    <li>Build using <em>Run-WsusSql.ps1</em>.</li>
    <li>Restore SUSDB from the upstream backup using <em>ImportScript.ps1</em>.</li>
    <li>Validate content path and permissions using <em>Check-WSUSContent.ps1</em>.</li>
    <li>Import WSUS content from the upstream export location.</li>
  </ul>

  <h2>Domain controller GPO setup</h2>
  <p>
    Use <em>Set-WsusGpo.ps1</em> to create or import the WSUS client GPO and apply the required
    Windows Update policy settings. Optionally link the GPO to the target OU.
  </p>

  <h2>Script catalog by category</h2>
  <h3>Install / setup</h3>
  <ul>
    <li>
      <strong>Run-WsusSql.ps1</strong>: Primary install flow for SQL Express + WSUS. Can optionally
      perform content validation after the install.
    </li>
    <li>
      <strong>install.ps1</strong>: Full SQL Express 2022 + SSMS + WSUS installation and configuration
      (silent SQL setup, firewall rules, WSUS post-install steps, IIS adjustments, and registry settings).
    </li>
    <li>
      <strong>Set-WsusGpo.ps1</strong>: Create/import WSUS client GPO and apply policy keys.
    </li>
  </ul>

  <h3>Import</h3>
  <ul>
    <li>
      <strong>ImportScript.ps1</strong>: Restore a SUSDB backup and re-attach WSUS to the restored DB.
      Automatically finds the newest backup in C:\WSUS and prompts before use.
    </li>
  </ul>

  <h3>Maintenance / utility</h3>
  <ul>
    <li>
      <strong>WsusMaintenance.ps1</strong>: Monthly automation (sync, declines, cleanup, and export).
      Includes optional ultimate cleanup before export.
    </li>
    <li>
      <strong>Ultimate-WsusCleanup.ps1</strong>: Deep cleanup (supersedence cleanup, index maintenance,
      stats updates, and shrink) for quarterly or emergency use.
    </li>
    <li>
      <strong>Reset-WsusContent.ps1</strong>: Force full WSUS content re-validation.
    </li>
    <li>
      <strong>Force-WSUSCheckIn.ps1</strong>: Force a WSUS client check-in (useful for troubleshooting).
    </li>
  </ul>

  <h3>Troubleshooting / validation</h3>
  <ul>
    <li>
      <strong>Run-WsusTroubleshooter.ps1</strong>: Service-level auto-fixes (SQL/WSUS/IIS) and
      WSUS content validation.
    </li>
    <li>
      <strong>Check-WSUSContent.ps1</strong>: Validate and repair content path, permissions, and
      content-related configuration (SUSDB, registry, IIS virtual directory).
    </li>
    <li>
      <strong>autofix.ps1</strong>: Detect and fix common WSUS + SQL service issues.
    </li>
  </ul>

  <h2>Maintenance cadence</h2>
  <ul>
    <li><strong>Monthly</strong>: Run <em>WsusMaintenance.ps1</em> on the online WSUS server.</li>
    <li><strong>Quarterly / as needed</strong>: Run <em>Ultimate-WsusCleanup.ps1</em>.</li>
    <li><strong>As needed</strong>: Run <em>Reset-WsusContent.ps1</em> to re-validate content.</li>
  </ul>

  <h2>Transfer guidance (online to airgapped)</h2>
  <p>
    Use a robust copy method (e.g., Robocopy) to move <strong>D:\WSUS-Exports</strong> from the online
    server to the airgapped WSUS server. Keep export logs in <strong>C:\Logs</strong> for traceability.
  </p>

  <h2>Notes and known behaviors</h2>
  <ul>
    <li><strong>Content path must be C:\WSUS.</strong> Other paths can cause endless downloads and an
      unregistered file state in SUSDB.</li>
    <li>The install workflow removes its temporary encrypted SQL SA password file on completion.</li>
    <li><em>ImportScript.ps1</em> scans C:\WSUS for the newest .bak file and prompts before restore.</li>
  </ul>
</body>
</html>
